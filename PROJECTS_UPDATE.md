# Projects Data Structure Migration Plan

## Executive Summary

This document outlines a simplified plan to normalize the projects data structure across the plixo-web application. Currently, project data is fragmented across multiple interfaces and sources. This migration will:
1. Use a **simplified unified Project interface** (13 fields, no nested objects)
2. Move project data to the **API with SQLite database backing**
3. Enable **Admin Console management** for CRUD operations
4. **No transformation needed** - data flows directly from DB ‚Üí API ‚Üí ProjectCard

See [DATA_STRUCTURE_MAP.md](DATA_STRUCTURE_MAP.md) for detailed comparison of current vs. proposed structures.

## Current State Analysis

### Data Structure Problems

1. **Three Conflicting Interfaces**
   - `WorkProject` (Work.tsx) - Simplified interface with basic fields
   - `Project` (portfolio.ts) - Comprehensive interface with rich metadata
   - `ProjectCardProps` (ProjectCard.tsx) - Display-specific interface

2. **Multiple Data Sources**
   - `/config/work-projects.json` - Static JSON file loaded by Work.tsx
   - `/src/config/temp-data.ts` - Has projects data but not currently used by Work page
   - No API backend for projects data

3. **Type Inconsistencies**
   ```typescript
   // WorkProject (simplified)
   interface WorkProject {
     title: string
     description: string
     technologies: string[]  // Just strings
     status: "Live" | "Demo" | "In Development" | "Archived" | "Prototype"
     image?: string
     liveUrl?: string
     githubUrl?: string
     demoUrl?: string
     featured?: boolean
   }

   // Project (comprehensive)
   interface Project {
     id: string
     title: string
     description: string
     longDescription?: string
     technologies: Technology[]  // Rich objects
     category: ProjectCategory
     status: ProjectStatus
     metrics?: ProjectMetrics
     urls: ProjectUrls
     images: ProjectImages
     featured: boolean
     priority: number
     dateCreated: string
     lastUpdated: string
     teamSize?: number
     role: string
     duration?: string
     businessImpact?: string
     technicalChallenges?: string[]
     learningsAndGrowth?: string[]
   }

   // ProjectCardProps (display-specific)
   interface ProjectCardProps {
     title: string
     description: string
     technologies: string[]  // Flattened
     status: "Live" | "Demo" | "In Development" | "Archived" | "Prototype"
     image?: string
     liveUrl?: string
     githubUrl?: string
     demoUrl?: string
     featured?: boolean
     className?: string
   }
   ```

4. **Maintenance Issues**
   - Static JSON requires manual editing and deployment to update
   - No versioning or audit trail for project changes
   - No validation or data integrity checks
   - Duplicate data definitions across files

## Target State Architecture

### Unified Data Model (SIMPLIFIED)

**Primary Interface**: Simplified flat structure with NO nested objects or complex types.

See [DATA_STRUCTURE_MAP.md](DATA_STRUCTURE_MAP.md) for full comparison and rationale.

```typescript
export interface Project {
  // Identity
  id: string                       // UUID, generated by API

  // Content
  title: string                    // Project name
  description: string              // Short description for cards (2-3 sentences)

  // Technical
  technologies: string[]           // Array of tech names: ["React", "TypeScript", "Tailwind"]
  status: ProjectStatus            // "Live" | "Demo" | "In Development" | "Archived" | "Prototype"

  // Media
  image: string                    // Thumbnail for project card (e.g., "/assets/projects/foo.jpg")

  // Links (all optional)
  live_url?: string                // Production URL
  github_url?: string              // GitHub repo
  demo_url?: string                // Demo/staging URL

  // Display
  featured: boolean                // Show on homepage/featured section
  priority: number                 // Sort order for featured (lower = higher priority)

  // Timestamps (managed by API)
  created_at: string               // ISO 8601 timestamp
  updated_at: string               // ISO 8601 timestamp
}

export type ProjectStatus =
  | "Live"              // Production, publicly available
  | "Demo"              // Demo/staging environment
  | "In Development"    // Work in progress
  | "Archived"          // No longer maintained
  | "Prototype"         // Experimental/proof of concept
```

**Total Fields**: 13 (10 project fields + 2 timestamps + 1 id)
- **Required**: 8 (id, title, description, technologies, status, image, featured, priority)
- **Optional**: 3 (live_url, github_url, demo_url)
- **System Managed**: 2 (created_at, updated_at)
- **Nested Objects**: NONE ‚úÖ
- **Complex Types**: NONE ‚úÖ

**Key Simplifications from Complex Model**:
- ‚ùå Removed: longDescription, category, metrics, role, teamSize, duration, businessImpact, technicalChallenges, learningsAndGrowth
- ‚ùå Removed: Nested objects (ProjectUrls, ProjectImages, ProjectMetrics, Technology objects)
- ‚úÖ Kept: All essential fields that WorkProject and ProjectCardProps use
- üîÑ Changed: liveUrl ‚Üí live_url (snake_case for DB consistency)
```

### Database Schema (SIMPLIFIED)

**Table: `projects`**

```sql
CREATE TABLE projects (
  -- Identity
  id TEXT PRIMARY KEY,

  -- Content
  title TEXT NOT NULL,
  description TEXT NOT NULL,

  -- Technical
  technologies TEXT NOT NULL,        -- JSON array: ["React", "TypeScript"]
  status TEXT NOT NULL CHECK(status IN ('Live', 'Demo', 'In Development', 'Archived', 'Prototype')),

  -- Media
  image TEXT NOT NULL,               -- Relative path to image

  -- Links
  live_url TEXT,
  github_url TEXT,
  demo_url TEXT,

  -- Display
  featured INTEGER NOT NULL DEFAULT 0,   -- SQLite boolean (0 or 1)
  priority INTEGER NOT NULL DEFAULT 0,

  -- Timestamps
  created_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for common queries
CREATE INDEX idx_projects_featured ON projects(featured, priority);
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_updated ON projects(updated_at DESC);
```

**Storage Strategy**:
- `technologies`: Store as JSON array string: `'["React","TypeScript","Tailwind"]'`
- `featured`: SQLite INTEGER (0 = false, 1 = true)
- All other fields: Native SQLite types (TEXT)
- Only **1 JSON field** (technologies) instead of 8+ in complex model

## API Design

### Endpoints Required

#### Public Endpoints (no authentication)

```
GET /projects
- Returns all published projects
- Query params: featured, category, status, limit, offset
- Response: { projects: Project[], total: number }

GET /projects/:id
- Returns single project by ID
- Response: { project: Project }
```

#### Admin Endpoints (requires admin role)

```
GET /admin/projects
- Returns all projects including drafts
- Query params: status, category, limit, offset
- Response: { projects: Project[], total: number }

POST /admin/projects
- Creates new project
- Body: Omit id, dateCreated, lastUpdated, created_at, updated_at
- Response: { project: Project }

PUT /admin/projects/:id
- Updates existing project
- Body: Partial<Project> (cannot change id, dateCreated)
- Response: { project: Project }

DELETE /admin/projects/:id
- Soft delete (set status to 'Archived')
- Response: { success: boolean }

POST /admin/projects/:id/publish
- Changes status to 'Live'
- Response: { project: Project }

POST /admin/projects/:id/featured
- Toggles featured status
- Response: { project: Project }

POST /admin/projects/:id/priority
- Updates priority order
- Body: { priority: number }
- Response: { project: Project }
```

### API Implementation Details

**File structure:**
```
api/src/
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ projects.ts          # Public project routes
‚îÇ   ‚îî‚îÄ‚îÄ admin/
‚îÇ       ‚îî‚îÄ‚îÄ projects.ts      # Admin project routes
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 000X_create_projects_table.sql
‚îÇ   ‚îî‚îÄ‚îÄ queries/
‚îÇ       ‚îî‚îÄ‚îÄ projects.ts      # SQL queries for projects
‚îî‚îÄ‚îÄ types/
    ‚îî‚îÄ‚îÄ projects.ts          # Shared types (import from portfolio.ts)
```

**Validation:**
- Use Zod schemas for request validation
- Validate enum values (status, category, technology categories)
- Ensure required fields are present
- Validate URL formats
- Validate date formats (ISO 8601)

**Authorization:**
- Public endpoints: No auth required
- Admin endpoints: Require admin role (use existing verifyRole middleware)
- Track created_by and updated_by using JWT user info

## Frontend Changes

### 1. Remove Static JSON

- Delete `/config/work-projects.json`
- Remove static JSON loading from Work.tsx

### 2. Update Work.tsx

```typescript
// OLD: Loading from static JSON
useEffect(() => {
  const fetchProjects = async () => {
    const response = await fetch("/config/work-projects.json");
    const data = await response.json();
    setProjects(data);
  };
  fetchProjects();
}, []);

// NEW: Loading from API using Project type
import { Project } from '../types/portfolio';

useEffect(() => {
  const fetchProjects = async () => {
    try {
      const response = await api.get<{ projects: Project[] }>('/projects', {
        params: { featured: true }  // Get featured projects for Work page
      });
      setProjects(response.data.projects);
    } catch (error) {
      console.error('Failed to fetch projects:', error);
      toast.error('Failed to load projects');
    }
  };
  fetchProjects();
}, []);
```

### 3. Update ProjectCard.tsx

Transform `Project` to `ProjectCardProps` at the component level:

```typescript
// Add adapter function
function projectToCardProps(project: Project): ProjectCardProps {
  return {
    title: project.title,
    description: project.description,
    technologies: project.technologies.map(t => t.name),  // Flatten to strings
    status: project.status,
    image: project.images.thumbnail,
    liveUrl: project.urls.live,
    githubUrl: project.urls.github,
    demoUrl: project.urls.demo,
    featured: project.featured,
  };
}

// Use in Work.tsx
{projects.map(project => (
  <ProjectCard key={project.id} {...projectToCardProps(project)} />
))}
```

### 4. Create Admin Console Projects Manager

New component: `src/components/admin/ProjectsManager.tsx`

Features:
- List all projects with filtering (status, category, featured)
- Create new project form with all fields
- Edit existing project
- Delete/archive project
- Toggle featured status
- Reorder featured projects (drag-and-drop or priority input)
- Preview project card rendering
- Image upload for thumbnails/gallery
- Technology selector with autocomplete
- Rich text editor for long descriptions

### 5. Update GlobalContext (Optional)

Consider whether GlobalContext should still maintain projects state or if each page should fetch directly:

**Option A: Remove from GlobalContext**
- Pages fetch projects directly when needed
- Simpler state management
- No stale data issues

**Option B: Keep in GlobalContext**
- Add API fetching to GlobalContext
- Invalidate cache on updates
- Share data across pages

**Recommendation**: Option A (remove from GlobalContext) - projects are only used on Work page, no need for global state.

## Implementation Strategy

### Recommended Approach: API-First with Admin Console Entry

**Implementation Order**:
1. **API First** (local development)
   - Create migration and table schema
   - Implement API endpoints (public + admin)
   - Test with curl/Postman locally

2. **Deploy API** (production)
   - Deploy API changes to production
   - Run migration on production database

3. **Admin Console UI** (local ‚Üí production)
   - Build ProjectsManager component
   - Test creating one project via UI
   - Deploy frontend

4. **Data Population** (production)
   - Admin creates first project via Console UI (verify it works)
   - Use curl commands to bulk-create remaining projects from work-projects.json

5. **Frontend Integration** (local ‚Üí production)
   - Update Work.tsx to fetch from API
   - Remove work-projects.json
   - Deploy

### Environment Strategy

**Should we work locally for API refactor?**

**YES - Recommended approach**:
- ‚úÖ Develop API endpoints locally with local D1 database
- ‚úÖ Test thoroughly with local data
- ‚úÖ Avoid breaking production while iterating
- ‚úÖ Can test full flow: API ‚Üí Admin Console ‚Üí Work page
- ‚úÖ Once working locally, deploy to production in one go

**Local Development Setup**:
```bash
# In api directory
npm run dev              # Start local API server
npx wrangler d1 execute plixo-db --local --file=./src/db/migrations/000X_create_projects_table.sql

# In plixo-web directory
# Update .env.development to point to local API
VITE_API_URL=http://localhost:8787
npm run dev
```

### Migration Phases (SIMPLIFIED)

#### Phase 1: API Development (Local) - 2-3 days
1. Create migration file: `000X_create_projects_table.sql`
2. Create API routes:
   - `GET /projects` (public)
   - `GET /projects/:id` (public)
   - `POST /admin/projects` (admin)
   - `PUT /admin/projects/:id` (admin)
   - `DELETE /admin/projects/:id` (admin)
3. Add Zod validation schemas
4. Test locally with curl commands

#### Phase 2: Deploy API (Production) - 1 day
1. Deploy API to production
2. Run migration on production D1
3. Verify endpoints work with curl

#### Phase 3: Admin Console (Local ‚Üí Production) - 2-3 days
1. Create `ProjectsManager.tsx` component
2. Add to Console.tsx
3. Test creating/editing projects locally
4. Deploy frontend to production
5. Test creating ONE project via production UI

#### Phase 4: Data Population (Production) - 1 hour
1. Transform work-projects.json to Project format
2. Create curl script to POST each project
3. Run script against production API
4. Verify all projects in database

#### Phase 5: Frontend Integration (Local ‚Üí Production) - 1 day
1. Update Work.tsx to use API
2. Remove work-projects.json
3. Test locally
4. Deploy to production
5. Verify Work page displays all projects

## Data Transformation (SIMPLIFIED)

### Mapping WorkProject to Project

**No complex transformation needed!** Simple field renaming only:

```typescript
// Simple transformation function
function transformWorkProjectToProject(workProject: WorkProject): Omit<Project, 'id' | 'created_at' | 'updated_at'> {
  return {
    title: workProject.title,
    description: workProject.description,
    technologies: workProject.technologies,  // Already string[] ‚úÖ
    status: workProject.status,              // Already correct type ‚úÖ
    image: workProject.image || '/assets/default-project.jpg',
    live_url: workProject.liveUrl,           // Rename: liveUrl ‚Üí live_url
    github_url: workProject.githubUrl,       // Rename: githubUrl ‚Üí github_url
    demo_url: workProject.demoUrl,           // Rename: demoUrl ‚Üí demo_url
    featured: workProject.featured || false,
    priority: 0,  // Set manually in Admin Console after import
  };
}

// Example transformation
const workProject = {
  title: "Analytics Dashboard",
  description: "Real-time analytics platform",
  technologies: ["React", "D1", "Cloudflare Workers"],
  status: "Live",
  image: "/assets/projects/analytics.jpg",
  liveUrl: "https://analytics.plixo.com",
  githubUrl: "https://github.com/user/analytics",
  featured: true
};

// Transforms to:
const project = {
  title: "Analytics Dashboard",
  description: "Real-time analytics platform",
  technologies: ["React", "D1", "Cloudflare Workers"],
  status: "Live",
  image: "/assets/projects/analytics.jpg",
  live_url: "https://analytics.plixo.com",
  github_url: "https://github.com/user/analytics",
  demo_url: undefined,
  featured: true,
  priority: 0
};
// API generates: id, created_at, updated_at
```

## Breaking Changes

**Since we're in dev mode, we're NOT maintaining backwards compatibility.**

### Changes Being Made:

1. **Field Name Changes** (camelCase ‚Üí snake_case):
   - `liveUrl` ‚Üí `live_url`
   - `githubUrl` ‚Üí `github_url`
   - `demoUrl` ‚Üí `demo_url`

2. **Component Updates**:
   - Update `ProjectCard.tsx` to accept `live_url`, `github_url`, `demo_url`
   - Update `Work.tsx` to fetch from API instead of static JSON
   - Remove `work-projects.json` entirely

3. **Type Updates**:
   - Update or replace `WorkProject` interface with simplified `Project`
   - Ensure `ProjectCardProps` matches new field names

**No Adapter Functions Needed** - Direct mapping from API ‚Üí Component ‚úÖ

## Testing Requirements

### API Tests

```typescript
describe('Projects API', () => {
  describe('GET /projects', () => {
    it('returns all published projects')
    it('filters by featured status')
    it('filters by category')
    it('filters by status')
    it('paginates results')
  })

  describe('GET /projects/:id', () => {
    it('returns single project by ID')
    it('returns 404 for non-existent project')
  })

  describe('POST /admin/projects', () => {
    it('creates new project with valid data')
    it('rejects invalid data')
    it('requires admin authentication')
    it('tracks created_by user')
  })

  describe('PUT /admin/projects/:id', () => {
    it('updates existing project')
    it('prevents changing immutable fields')
    it('requires admin authentication')
    it('tracks updated_by user')
  })

  describe('DELETE /admin/projects/:id', () => {
    it('soft deletes project')
    it('requires admin authentication')
  })
})
```

### Frontend Tests

```typescript
describe('Work Page', () => {
  it('loads projects from API')
  it('displays projects in grid')
  it('handles API errors gracefully')
  it('filters featured projects')
})

describe('ProjectCard', () => {
  it('renders project data correctly')
  it('displays technology tags')
  it('shows appropriate status badge')
  it('links to live/demo/github URLs')
})

describe('ProjectsManager', () => {
  it('lists all projects for admin')
  it('creates new project')
  it('edits existing project')
  it('deletes project')
  it('toggles featured status')
  it('updates priority order')
})
```

## Rollout Strategy

### Development Environment

1. Create feature branch: `feature/projects-api-migration`
2. Implement API changes
3. Test with local database
4. Implement frontend changes
5. Test end-to-end locally

### Staging Environment

1. Deploy API changes to staging
2. Run database migrations
3. Import seed data
4. Deploy frontend changes
5. Test admin console functionality
6. Verify Work page displays correctly

### Production Rollout

1. **Pre-deployment:**
   - Backup current work-projects.json
   - Prepare rollback plan
   - Test in staging one final time

2. **Deployment:**
   - Deploy API changes (backend first)
   - Run database migrations
   - Import production data
   - Deploy frontend changes
   - Verify Work page loads

3. **Post-deployment:**
   - Monitor error logs
   - Verify analytics tracking
   - Test admin console access
   - Create initial projects via Admin Console
   - Remove work-projects.json in follow-up deployment

4. **Rollback Plan:**
   - If API fails: Revert API deployment, frontend continues using static JSON
   - If frontend fails: Revert frontend, restore work-projects.json temporarily
   - Database changes are non-destructive (new table), safe to leave in place

## Timeline Estimate (SIMPLIFIED)

- **Phase 1: API Development (Local)**: 2-3 days
- **Phase 2: Deploy API**: 1 day
- **Phase 3: Admin Console UI**: 2-3 days
- **Phase 4: Data Population**: 1 hour (curl scripts)
- **Phase 5: Frontend Integration**: 1 day

**Total: ~1-1.5 weeks** (much faster due to simplified data model)

## Success Criteria

1. ‚úÖ Projects load from API on Work page
2. ‚úÖ Admin can create/edit/delete projects via Console
3. ‚úÖ Featured projects display correctly
4. ‚úÖ All existing project data preserved
5. ‚úÖ No breaking changes to existing components
6. ‚úÖ work-projects.json removed from codebase
7. ‚úÖ API tests pass with >80% coverage
8. ‚úÖ Frontend tests pass
9. ‚úÖ No console errors in production
10. ‚úÖ Performance: Work page loads in <2s

## Future Enhancements

1. **Project Detail Pages**: Full project view with longDescription, metrics, challenges
2. **Tags/Labels**: Additional taxonomy beyond categories
3. **Search**: Full-text search across projects
4. **Versioning**: Track project history and changes over time
5. **Comments**: Internal notes on projects for team collaboration
6. **Analytics**: Track which projects get the most views
7. **Image Management**: Upload and manage project images via Admin Console
8. **Bulk Operations**: Import/export projects, bulk status updates
9. **Project Templates**: Predefined project structures for quick creation
10. **Related Projects**: Link projects that are related or part of a series

## References

- Current Work.tsx: `/src/pages/Work.tsx`
- Project types: `/src/types/portfolio.ts`
- ProjectCard component: `/src/components/molecules/ProjectCard.tsx`
- Static data: `/config/work-projects.json`
- Admin Console: `/src/pages/Console.tsx`
- API structure: `/api/src/`
